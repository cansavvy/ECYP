---
title: "ECYP Fellows and Alumni Database"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: embed
runtime: shiny
---

```{r}
# Purpose of this Rmd is to host a Shint app that allows alumni to use their unique ID to access their information in the
# Alumni spreadsheet and be able to update that information
```

```{r global, include=FALSE}
# Install packages if needed
if (!("dplyr" %in% installed.packages())) {
  install.packages("dplyr")
}
if (!("ggplot2" %in% installed.packages())) {
  install.packages("ggplot2")
}
if (!("tidyverse" %in% installed.packages())) {
  install.packages("tidyverse")
}
if (!("tidyr" %in% installed.packages())) {
  install.packages("tidyr")
}
if (!("flexdashboard" %in% installed.packages())) {
  install.packages("flexdashboard")
}
if (!("DT" %in% installed.packages())) {
  install.packages("DT")
}
if (!("gsheet" %in% installed.packages())) {
  install.packages("gsheet")
}
library(magrittr)
library(shiny)
```

```{r input_demo, eval = FALSE}
# For testing purposes
input <-list(
  enter_number = NULL,
  variable = NULL,
  new_value = NULL
)
```

```{r}
# This is the hard-coded in url to the Alumni Master File that the data is kept in.
sheet_url <- "https://docs.google.com/spreadsheets/d/1rQaqQIYLZw1tZnJZQHMNhTf0-zDRH2zWzA6Eo0giP80/edit#gid=1665986408"

# This function gets the sheet_id from the url provided
get_sheet_id <- function(sheet_url) {
  sheet_id <- googledrive::drive_get(id = sheet_url)$id
  return(sheet_id)
}

# This function reads the googlesheet from online 
refresh_db <- function(sheet_url) {
  # Read in sheet
  ecyp_db_org <- gsheet::gsheet2tbl(sheet_url) %>%
    data.frame() %>%
    dplyr::mutate_all(as.character)

  return(ecyp_db_org)
}

# This function takes the googlesheet and sets up the table the user will see
refresh_table <- function(sheet_url) {
  ecyp_db_org <- refresh_db(sheet_url)

  # Delete a column
  ecyp_db <- ecyp_db_org %>% 
    dplyr::select(-Name_Original, -Notes)

  return(ecyp_db)
}
```

```{r}
# Set up the data from the Googlesheet and store in global environment
sheet_id <- get_sheet_id(sheet_url)
ecyp_db_org <- refresh_db(sheet_url)
ecyp_db <- refresh_table(sheet_url)

# Set up the variable list based on this but don't show the user ID
variable_list <- setdiff(names(ecyp_db), c("Unique_Number", "Last_Updated"))
names(variable_list) <- gsub("_", "", setdiff(names(ecyp_db), c("Unique_Number", "Last_Updated")))
```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
## Set up the user's input buttons 

# Have the user specify their ID number
textInput("enter_number", label = h4("Enter your number"), value = NULL)

# Have the user choose what variable from the table they want to change
selectInput("variable",
  label = h4("Choose which field to update Info:"),
  choices = variable_list, 
  selected = NULL
)

# Have the user write in the new value and click submit when they are done
renderUI({
  basicPage(
    textInput("new_value", label = h4("Enter the new value for ", variable_choice()), value = NULL),
    submitButton("Update Info", icon("fas fa-sync"))
  )
})
```

```{r}
# Set up inputs to be reactive

# This variable has the user's input for what their ID is. 
enter_number <- reactive({
  if (!is.null(input$enter_number)) {
    input$enter_number
  }
})

# This variable has the users' input for what variable they'd like to change
variable_choice <- reactive({
  if (!is.null(input$variable)) {
    names(variable_list)[[which(variable_list == input$variable)]]
  }
})

# This variable has the users' input for what the new value will be 
new_value <- reactive({
  if (!is.null(input$new_value)) {
    input$new_value
  }
})
```

## Column

```{r, echo = F}
# Set up the table to be rendered
ecyp_updated <- reactive({
  if (!is.null(enter_number())) {
    refresh_table(sheet_url) %>% 
      dplyr::filter(Unique_Number == enter_number())
  }
})

renderUI({ 
  if (length(new_value()) > 0) {
    tableOutput("ecyp_table")
  } 
})

# Load the reactive values into data table
renderTable({ecyp_updated()})
```


```{r}
# If a new value is given, we want to put write it in the main googlesheet underneath the given variable name
observeEvent(new_value(), {
  if (is.null(new_value())) {
    return()
  }
  if (is.null(variable_choice())) {
    return()
  }
  sheet_url <- "https://docs.google.com/spreadsheets/d/1rQaqQIYLZw1tZnJZQHMNhTf0-zDRH2zWzA6Eo0giP80/edit#gid=1665986408"

  sheet_id <- get_sheet_id(sheet_url)
  ecyp_db_org <- refresh_db(sheet_url)
  ecyp_db <- refresh_table(sheet_url)

  ecyp_db_org[which(ecyp_db_org$Unique_Number == enter_number()), variable_choice()] <-
    as.character(new_value())

  ecyp_db_org[which(ecyp_db_org$Unique_Number == enter_number()), ]$Last_Updated <- as.character(Sys.time())

  googlesheets4::sheet_write(
    data = ecyp_db_org,
    ss = sheet_id,
    sheet = "Master Spreadsheet"
  )

})
```

