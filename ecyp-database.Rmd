---
title: "ECYP Fellows and Alumni Database"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: embed
runtime: shiny
---

```{r global, include=FALSE}
# Install packages if needed
if (!("dplyr" %in% installed.packages())) {
  install.packages("dplyr")
}
if (!("ggplot2" %in% installed.packages())) {
  install.packages("ggplot2")
}
if (!("tidyverse" %in% installed.packages())) {
  install.packages("tidyverse")
}
if (!("tidyr" %in% installed.packages())) {
  install.packages("tidyr")
}
if (!("flexdashboard" %in% installed.packages())) {
  install.packages("flexdashboard")
}
if (!("DT" %in% installed.packages())) {
  install.packages("DT")
}
if (!("gsheet" %in% installed.packages())) {
  install.packages("gsheet")
}
library(magrittr)
library(shiny)
```

```{r input_demo, eval = FALSE}
input <-list(
  enter_number = NULL,
  variable = NULL,
  new_value = NULL
  refreshed = FALSE
)
```

```{r}
sheet_url <- "https://docs.google.com/spreadsheets/d/1rQaqQIYLZw1tZnJZQHMNhTf0-zDRH2zWzA6Eo0giP80/edit#gid=1665986408"

get_sheet_id <- function(sheet_url) {
  sheet_id <- googledrive::drive_get(id = sheet_url)$id

  return(sheet_id)
}

refresh_db <- function(sheet_url) {

  # Read in sheet
  ecyp_db_org <- gsheet::gsheet2tbl(sheet_url) %>%
    data.frame() %>%
    dplyr::mutate_all(as.character)

  return(ecyp_db_org)
}

refresh_table <- function(sheet_url) {
  ecyp_db_org <- refresh_db(sheet_url)

  # Delete a column
  ecyp_db <- ecyp_db_org[-c(2, 13, 14, 18)]

  ## changing numeric column to character
  ecyp_db <- ecyp_db %>%
    dplyr::mutate_all(as.character)

  return(ecyp_db)
}
```

```{r}
sheet_id <- get_sheet_id(sheet_url)
ecyp_db_org <- refresh_db(sheet_url)
ecyp_db <- refresh_table(sheet_url)

variable_list <- names(ecyp_db)[-2]
names(variable_list) <- names(ecyp_db)[-2]
```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
textInput("enter_number", label = h4("Enter your number"), value = NULL)

selectInput("variable",
  label = h4("Choose which field to update Info:"),
  choices = colnames(ecyp_db)[-2], 
  selected = NULL
)

variable.choice <- reactive({
  if (!is.null(input$variable)) {
    names(variable_list)[[which(variable_list == input$variable)]]
  }
})

renderUI({
  basicPage(
    textInput("new_value", label = h4("Enter the new value for ", variable.choice()), value = NULL),
    submitButton("Update Info", icon("fas fa-sync"))
  )
})
```

## Column

```{r}
ecyp_updated <- reactive(
  if (!is.null(input$enter_number) || refreshed) {
    refresh_table(sheet_url) %>% 
      dplyr::filter(Unique_Number == input$enter_number)
    refreshed <- FALSE
  }
)

# Load the reactive values into data table
renderDataTable({
  ecyp_updated()
})
```


```{r}
value_updated <- reactive(
  if(!is.null(input$new_value)) {
    input$new_value
  } else {
    return()
  }
)

observeEvent(value_updated(), {
  if (is.null(value_updated())) {
    return()
  }
  if (is.null(variable.choice())) {
    return()
  }
  sheet_url <- "https://docs.google.com/spreadsheets/d/1rQaqQIYLZw1tZnJZQHMNhTf0-zDRH2zWzA6Eo0giP80/edit#gid=1665986408"

  sheet_id <- get_sheet_id(sheet_url)
  ecyp_db_org <- refresh_db(sheet_url)
  ecyp_db <- refresh_table(sheet_url)

  ecyp_db_org[which(ecyp_db_org$Unique_Number == input$enter_number), variable.choice()] <-
    as.character(value_updated())

  ecyp_db_org[which(ecyp_db_org$Unique_Number == input$enter_number), ]$Last_Updated <- as.character(Sys.time())

  googlesheets4::sheet_write(
    data = ecyp_db_org,
    ss = sheet_id,
    sheet = "Master Spreadsheet"
  )
  
  refreshed <- TRUE
})
```


